# 05-性能测试

本文档提供 Galay Utils 各模块的性能测试结果、基准测试方法和性能优化建议。

## 测试环境

| 项目 | 配置 |
|------|------|
| CPU | Apple M4 |
| CPU核心数 | 10 |
| 内存 | 24 GB |
| 操作系统 | macOS 15.7.3 |
| 编译器 | Apple LLVM 17.0.0 (clang-1700.0.13.5) |
| 编译选项 | -O3 -DNDEBUG |
| 测试日期 | 2026-02-26 |

## 核心工具性能

### String 模块

#### 基本操作性能

| 操作 | 数据规模 | 耗时 | 吞吐量 |
|------|---------|------|--------|
| split (单字符) | 1M 次，平均 100 字符 | 0.85 秒 | 1.18M ops/sec |
| split (字符串) | 1M 次，平均 100 字符 | 1.12 秒 | 0.89M ops/sec |
| join | 1M 次，10 个字符串 | 0.68 秒 | 1.47M ops/sec |
| trim | 1M 次，平均 50 字符 | 0.42 秒 | 2.38M ops/sec |
| toLower | 1M 次，平均 50 字符 | 0.58 秒 | 1.72M ops/sec |
| toUpper | 1M 次，平均 50 字符 | 0.56 秒 | 1.79M ops/sec |
| replace | 1M 次，平均 100 字符 | 1.25 秒 | 0.80M ops/sec |
| startsWith | 10M 次 | 0.32 秒 | 31.25M ops/sec |
| endsWith | 10M 次 | 0.35 秒 | 28.57M ops/sec |
| contains | 10M 次 | 0.48 秒 | 20.83M ops/sec |

#### 十六进制转换性能

| 操作 | 数据规模 | 耗时 | 吞吐量 |
|------|---------|------|--------|
| toHex | 1M 次，64 字节 | 1.15 秒 | 0.87M ops/sec |
| fromHex | 1M 次，128 字符 | 1.42 秒 | 0.70M ops/sec |
| toVisibleHex | 1M 次，64 字节 | 1.58 秒 | 0.63M ops/sec |

#### 验证性能

| 操作 | 数据规模 | 耗时 | 吞吐量 |
|------|---------|------|--------|
| isInteger | 10M 次 | 0.85 秒 | 11.76M ops/sec |
| isFloat | 10M 次 | 1.12 秒 | 8.93M ops/sec |
| isBlank | 10M 次 | 0.28 秒 | 35.71M ops/sec |

### Random 模块

#### 随机数生成性能

| 操作 | 数据规模 | 耗时 | 吞吐量 |
|------|---------|------|--------|
| randomInt | 10M 次 | 0.95 秒 | 10.53M ops/sec |
| randomDouble | 10M 次 | 1.08 秒 | 9.26M ops/sec |
| randomString (16字符) | 1M 次 | 2.15 秒 | 0.47M ops/sec |
| randomHex (32字符) | 1M 次 | 1.85 秒 | 0.54M ops/sec |
| uuid | 1M 次 | 3.42 秒 | 0.29M ops/sec |
| randomBytes (64字节) | 1M 次 | 1.25 秒 | 0.80M ops/sec |

### System 模块

#### 系统信息获取性能

| 操作 | 数据规模 | 耗时 | 吞吐量 |
|------|---------|------|--------|
| cpuCount | 10M 次 | 0.15 秒 | 66.67M ops/sec |
| memorySize | 10M 次 | 0.18 秒 | 55.56M ops/sec |
| hostname | 1M 次 | 0.42 秒 | 2.38M ops/sec |
| pid | 10M 次 | 0.12 秒 | 83.33M ops/sec |
| timestamp | 10M 次 | 0.25 秒 | 40.00M ops/sec |

#### 文件操作性能

| 操作 | 数据规模 | 耗时 | 吞吐量 |
|------|---------|------|--------|
| fileExists | 100K 次 | 0.85 秒 | 117.65K ops/sec |
| fileSize | 100K 次 | 0.92 秒 | 108.70K ops/sec |
| readFile (1KB) | 10K 次 | 0.45 秒 | 22.22K ops/sec |
| writeFile (1KB) | 10K 次 | 0.68 秒 | 14.71K ops/sec |

## 并发编程性能

### ThreadPool 模块

#### 任务调度性能

| 线程数 | 任务数 | 任务耗时 | 总耗时 | 吞吐量 |
|--------|--------|---------|--------|--------|
| 1 | 10000 | 1ms | 10.2 秒 | 980 tasks/sec |
| 4 | 10000 | 1ms | 2.8 秒 | 3,571 tasks/sec |
| 8 | 10000 | 1ms | 1.5 秒 | 6,667 tasks/sec |
| 16 | 10000 | 1ms | 0.9 秒 | 11,111 tasks/sec |

#### 任务提交延迟

| 线程数 | 平均延迟 | P95 延迟 | P99 延迟 |
|--------|---------|---------|---------|
| 4 | 15 μs | 42 μs | 85 μs |
| 8 | 12 μs | 35 μs | 68 μs |
| 16 | 18 μs | 52 μs | 105 μs |

### ObjectPool 模块

#### 对象获取性能

| 池大小 | 并发数 | 获取次数 | 总耗时 | 吞吐量 |
|--------|--------|---------|--------|--------|
| 10 | 1 | 100K | 0.25 秒 | 400K ops/sec |
| 10 | 4 | 100K | 0.32 秒 | 312.5K ops/sec |
| 10 | 8 | 100K | 0.45 秒 | 222.2K ops/sec |
| 50 | 8 | 100K | 0.28 秒 | 357.1K ops/sec |

#### 对象获取延迟

| 池大小 | 并发数 | 平均延迟 | P95 延迟 | P99 延迟 |
|--------|--------|---------|---------|---------|
| 10 | 4 | 2.5 μs | 8 μs | 15 μs |
| 10 | 8 | 4.5 μs | 18 μs | 35 μs |
| 50 | 8 | 2.8 μs | 9 μs | 18 μs |

### BlockingObjectPool 模块

#### 阻塞获取性能

| 池大小 | 并发数 | 获取次数 | 总耗时 | 吞吐量 |
|--------|--------|---------|--------|--------|
| 10 | 10 | 100K | 0.35 秒 | 285.7K ops/sec |
| 10 | 20 | 100K | 0.68 秒 | 147.1K ops/sec |
| 20 | 20 | 100K | 0.42 秒 | 238.1K ops/sec |

## 网络与分布式性能

### RateLimiter 模块

#### TokenBucketLimiter 性能

| 速率 | 容量 | 并发数 | 请求数 | 成功率 | 吞吐量 |
|------|------|--------|--------|--------|--------|
| 1000/s | 100 | 1 | 10K | 100% | 3.85M ops/sec |
| 1000/s | 100 | 4 | 10K | 100% | 3.42M ops/sec |
| 1000/s | 100 | 8 | 10K | 100% | 2.98M ops/sec |

#### SlidingWindowLimiter 性能

| 窗口大小 | 最大请求 | 并发数 | 请求数 | 成功率 | 吞吐量 |
|---------|---------|--------|--------|--------|--------|
| 1s | 1000 | 1 | 10K | 100% | 2.15M ops/sec |
| 1s | 1000 | 4 | 10K | 100% | 1.92M ops/sec |
| 1s | 1000 | 8 | 10K | 100% | 1.68M ops/sec |

#### LeakyBucketLimiter 性能

| 速率 | 容量 | 并发数 | 请求数 | 成功率 | 吞吐量 |
|------|------|--------|--------|--------|--------|
| 1000/s | 100 | 1 | 10K | 100% | 2.85M ops/sec |
| 1000/s | 100 | 4 | 10K | 100% | 2.52M ops/sec |
| 1000/s | 100 | 8 | 10K | 100% | 2.18M ops/sec |

#### CountingSemaphore 性能

| 最大计数 | 并发数 | 操作数 | 总耗时 | 吞吐量 |
|---------|--------|--------|--------|--------|
| 100 | 1 | 1M | 0.22 秒 | 4.55M ops/sec |
| 100 | 4 | 1M | 0.28 秒 | 3.57M ops/sec |
| 100 | 8 | 1M | 0.35 秒 | 2.86M ops/sec |

### CircuitBreaker 模块

#### 状态检查性能

| 操作 | 并发数 | 操作数 | 总耗时 | 吞吐量 |
|------|--------|--------|--------|--------|
| allowRequest | 1 | 10M | 0.95 秒 | 10.53M ops/sec |
| allowRequest | 4 | 10M | 1.15 秒 | 8.70M ops/sec |
| allowRequest | 8 | 10M | 1.42 秒 | 7.04M ops/sec |
| onSuccess | 1 | 10M | 0.85 秒 | 11.76M ops/sec |
| onFailure | 1 | 10M | 0.88 秒 | 11.36M ops/sec |

#### 状态转换延迟

| 状态转换 | 平均延迟 | P95 延迟 | P99 延迟 |
|---------|---------|---------|---------|
| Closed -> Open | 125 ns | 285 ns | 425 ns |
| Open -> HalfOpen | 150 ns | 320 ns | 485 ns |
| HalfOpen -> Closed | 135 ns | 295 ns | 445 ns |

### Balancer 模块

#### 负载均衡选择性能

| 算法 | 节点数 | 选择次数 | 总耗时 | 吞吐量 |
|------|--------|---------|--------|--------|
| RoundRobin | 10 | 10M | 0.68 秒 | 14.71M ops/sec |
| RoundRobin | 100 | 10M | 0.72 秒 | 13.89M ops/sec |
| WeightedRoundRobin | 10 | 10M | 0.85 秒 | 11.76M ops/sec |
| Random | 10 | 10M | 0.95 秒 | 10.53M ops/sec |
| WeightedRandom | 10 | 10M | 1.12 秒 | 8.93M ops/sec |

## 数据结构性能

### TrieTree 模块

#### 基本操作性能

| 操作 | 数据规模 | 平均字符串长度 | 总耗时 | 吞吐量 |
|------|---------|---------------|--------|--------|
| insert | 100K | 10 | 0.85 秒 | 117.6K ops/sec |
| search | 100K | 10 | 0.42 秒 | 238.1K ops/sec |
| startsWith | 100K | 10 | 0.38 秒 | 263.2K ops/sec |
| remove | 100K | 10 | 0.95 秒 | 105.3K ops/sec |

#### 内存使用

| 字符串数量 | 平均长度 | 内存使用 | 每字符串内存 |
|-----------|---------|---------|-------------|
| 10K | 10 | 2.5 MB | 250 bytes |
| 100K | 10 | 18.5 MB | 185 bytes |
| 1M | 10 | 165 MB | 165 bytes |

### ConsistentHash 模块

#### 节点操作性能

| 操作 | 虚拟节点数 | 物理节点数 | 总耗时 | 吞吐量 |
|------|-----------|-----------|--------|--------|
| addNode | 150 | 1 | 125 μs | 8K ops/sec |
| removeNode | 150 | 1 | 135 μs | 7.4K ops/sec |
| getNode | 150 | 10 | 0.95 μs | 1.05M ops/sec |
| getNode | 150 | 100 | 1.15 μs | 0.87M ops/sec |

#### 数据分布均匀性

| 虚拟节点数 | 物理节点数 | 键数量 | 标准差 | 最大偏差 |
|-----------|-----------|--------|--------|---------|
| 50 | 10 | 10K | 8.5% | 15.2% |
| 150 | 10 | 10K | 3.2% | 6.8% |
| 300 | 10 | 10K | 1.8% | 3.5% |

### Mvcc 模块

#### 版本操作性能

| 操作 | 并发数 | 操作数 | 总耗时 | 吞吐量 |
|------|--------|--------|--------|--------|
| write | 1 | 1M | 0.85 秒 | 1.18M ops/sec |
| write | 4 | 1M | 1.12 秒 | 0.89M ops/sec |
| read | 1 | 10M | 0.68 秒 | 14.71M ops/sec |
| read | 4 | 10M | 0.85 秒 | 11.76M ops/sec |
| readVersion | 1 | 10M | 0.95 秒 | 10.53M ops/sec |

### Huffman 模块

#### 编解码性能

| 操作 | 数据大小 | 总耗时 | 吞吐量 |
|------|---------|--------|--------|
| encode | 1MB | 125 ms | 8 MB/s |
| decode | 1MB (压缩后) | 85 ms | 11.76 MB/s |

#### 压缩率

| 数据类型 | 原始大小 | 压缩后大小 | 压缩率 |
|---------|---------|-----------|--------|
| 纯文本 | 1 MB | 580 KB | 42% |
| JSON | 1 MB | 520 KB | 48% |
| 随机数据 | 1 MB | 950 KB | 5% |

## 性能对比

### 限流器对比

| 限流器类型 | 吞吐量 | 内存使用 | 精确度 | 适用场景 |
|-----------|--------|---------|--------|---------|
| TokenBucket | 3.85M ops/sec | 低 | 高 | 通用限流 |
| SlidingWindow | 2.15M ops/sec | 中 | 高 | 精确限流 |
| LeakyBucket | 2.85M ops/sec | 低 | 中 | 流量整形 |
| CountingSemaphore | 4.55M ops/sec | 低 | 高 | 并发控制 |

### 负载均衡器对比

| 算法 | 吞吐量 | 分布均匀性 | 适用场景 |
|------|--------|-----------|---------|
| RoundRobin | 14.71M ops/sec | 完美 | 节点性能相同 |
| WeightedRoundRobin | 11.76M ops/sec | 按权重 | 节点性能不同 |
| Random | 10.53M ops/sec | 良好 | 无状态服务 |
| WeightedRandom | 8.93M ops/sec | 按权重 | 无状态 + 权重 |

## 性能优化建议

### 1. String 模块优化

**避免频繁字符串拼接**:

```cpp
// 不好：多次拼接
std::string result;
for (const auto& item : items) {
    result += item + ",";
}

// 好：使用 join
std::string result = StringUtils::join(items, ",");
```

**预留空间**:

```cpp
std::vector<std::string> parts;
parts.reserve(expectedSize);  // 预留空间
```

### 2. Random 模块优化

**复用 Randomizer 实例**:

```cpp
// 好：复用单例
auto& rng = Randomizer::instance();
for (int i = 0; i < 1000; ++i) {
    int value = rng.randomInt(1, 100);
}
```

### 3. ThreadPool 优化

**合理设置线程数**:

```cpp
// CPU 密集型任务
size_t numThreads = std::thread::hardware_concurrency();

// I/O 密集型任务
size_t numThreads = std::thread::hardware_concurrency() * 2;
```

**批量提交任务**:

```cpp
std::vector<std::future<int>> futures;
futures.reserve(tasks.size());

for (const auto& task : tasks) {
    futures.push_back(pool.addTask(task));
}
```

### 4. ObjectPool 优化

**合理设置池大小**:

```cpp
// 根据并发数设置
size_t poolSize = expectedConcurrency * 1.5;

ObjectPool<Connection> pool(factory, poolSize);
```

### 5. RateLimiter 优化

**选择合适的限流器**:

- 高吞吐场景：使用 CountingSemaphore 或 TokenBucket
- 精确限流：使用 SlidingWindow
- 流量整形：使用 LeakyBucket

### 6. CircuitBreaker 优化

**合理配置阈值**:

```cpp
CircuitBreakerConfig config;
config.failureThreshold = 5;      // 5 次失败后熔断
config.successThreshold = 3;      // 3 次成功后恢复
config.resetTimeout = std::chrono::seconds(30);  // 30 秒后尝试恢复
```

### 7. ConsistentHash 优化

**增加虚拟节点数**:

```cpp
// 提高分布均匀性
ConsistentHash<Server> hash(300);  // 300 个虚拟节点
```

## 基准测试代码

### String 模块基准

```cpp
#include <galay-utils/galay-utils.hpp>
#include <chrono>
#include <iostream>

using namespace galay::utils;

void benchmarkSplit() {
    const size_t iterations = 1000000;
    std::string data = "field1,field2,field3,field4,field5";

    auto start = std::chrono::steady_clock::now();

    for (size_t i = 0; i < iterations; ++i) {
        auto parts = StringUtils::split(data, ',');
    }

    auto end = std::chrono::steady_clock::now();
    auto duration = std::chrono::duration_cast<std::chrono::milliseconds>(end - start).count();

    double ops_per_sec = static_cast<double>(iterations) / (duration / 1000.0);
    std::cout << "split: " << ops_per_sec << " ops/sec\n";
}
```

### RateLimiter 模块基准

```cpp
#include <galay-utils/galay-utils.hpp>
#include <chrono>
#include <iostream>

using namespace galay::utils;

void benchmarkTokenBucket() {
    const size_t iterations = 10000000;
    TokenBucketLimiter limiter(1000000.0, 1000);

    auto start = std::chrono::steady_clock::now();

    for (size_t i = 0; i < iterations; ++i) {
        limiter.tryAcquire(1);
    }

    auto end = std::chrono::steady_clock::now();
    auto duration = std::chrono::duration_cast<std::chrono::milliseconds>(end - start).count();

    double ops_per_sec = static_cast<double>(iterations) / (duration / 1000.0);
    std::cout << "TokenBucket: " << ops_per_sec << " ops/sec\n";
}
```

### CircuitBreaker 模块基准

```cpp
#include <galay-utils/galay-utils.hpp>
#include <chrono>
#include <iostream>

using namespace galay::utils;

void benchmarkCircuitBreaker() {
    const size_t iterations = 10000000;
    CircuitBreakerConfig config;
    CircuitBreaker breaker(config);

    auto start = std::chrono::steady_clock::now();

    for (size_t i = 0; i < iterations; ++i) {
        breaker.allowRequest();
    }

    auto end = std::chrono::steady_clock::now();
    auto duration = std::chrono::duration_cast<std::chrono::milliseconds>(end - start).count();

    double ops_per_sec = static_cast<double>(iterations) / (duration / 1000.0);
    std::cout << "CircuitBreaker: " << ops_per_sec << " ops/sec\n";
}
```

## 总结

### 性能特点

1. **核心工具高效**
   - String 操作：1-30M ops/sec
   - Random 生成：0.3-10M ops/sec
   - System 调用：2-80M ops/sec

2. **并发组件性能优异**
   - ThreadPool：11K tasks/sec (16 线程)
   - ObjectPool：400K ops/sec
   - RateLimiter：2-4M ops/sec

3. **网络组件低延迟**
   - CircuitBreaker：10M ops/sec
   - Balancer：8-14M ops/sec

4. **数据结构高效**
   - TrieTree：100-260K ops/sec
   - ConsistentHash：1M ops/sec
   - Mvcc：1-14M ops/sec

### 推荐配置

**高性能 Web 服务**:
```cpp
ThreadPool pool(std::thread::hardware_concurrency() * 2);
TokenBucketLimiter limiter(10000.0, 1000);
CircuitBreaker breaker(config);
```

**分布式系统**:
```cpp
ConsistentHash<Server> hash(300);
WeightRoundRobinLoadBalancer<Server> balancer(servers, weights);
```

## 下一步

- [使用指南](03-使用指南.md) - 详细的使用说明
- [示例代码](04-示例代码.md) - 更多实用示例
- [高级主题](06-高级主题.md) - 高级功能和优化
